import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.model_selection import GridSearchCV
from sklearn.linear_model import LogisticRegression
from sklearn.svm import SVC
from sklearn.neural_network import MLPClassifier
from sklearn.tree import DecisionTreeClassifier
from sklearn.ensemble import RandomForestClassifier
from sklearn.ensemble import AdaBoostClassifier
from sklearn.model_selection import KFold
from sklearn.metrics import accuracy_score
from sklearn.metrics import confusion_matrix
from sklearn.metrics import roc_auc_score
from sklearn.metrics import roc_curve
from sklearn.metrics import classification_report
import matplotlib.pyplot as plt
import warnings
warnings.filterwarnings("ignore")
#Stacking-BPNN+SVM+RF+Adaboost
data_f=pd.read_excel(r'……\数据.xlsx',sheet_name='MLP+F')
data_ft=pd.read_excel(r'……\数据.xlsx',sheet_name='MLP+FT(GP)')
X_f=data_f.iloc[:,4:].values
Y_f=data_f.iloc[:,1].values
X_ft=data_ft.iloc[:,4:].values
Y_ft=data_ft.iloc[:,1].values
#Financial+Text
Xtrain_ft, Xtest_ft, Ytrain_ft, Ytest_ft = train_test_split(X_ft,Y_ft,test_size=0.3,stratify=Y_ft)
kf=KFold(n_splits=12,shuffle=True,random_state=100)
n_train=Xtrain_ft.shape[0]
n_test=Xtest_ft.shape[0]

models=[
    MLPClassifier(hidden_layer_sizes=(6, ), 
                 activation='identity',
                 solver='lbfgs',
                 max_iter=5000,
                 random_state=60),
        SVC(C=2.86286357657657,
          kernel='rbf',
          gamma=0.010011009009009,
          probability=True),
        RandomForestClassifier(n_estimators=126,
                             max_depth=46,
                             min_samples_leaf=6,
                             min_samples_split=18,
                             max_features=15,
                             random_state=60)
]

def get_oof(model,x_train,y_train,x_test):
    oof_train=np.zeros((n_train,)) 
    oof_test=np.zeros((n_test,))  
    oof_test_skf=np.zeros((12,n_test)) 
    for i,(train_index,test_index) in enumerate(kf.split(x_train)):
        kf_x_train=x_train[train_index]              
        kf_y_train=y_train[train_index]            
        kf_x_test=x_train[test_index]               
        model=model.fit(kf_x_train,kf_y_train)
        oof_train[test_index]=model.predict(kf_x_test)      
        oof_test_skf[i,:]=model.predict(x_test)             
    oof_test[:]=oof_test_skf.mean(axis=0)           
    return oof_train,oof_test     
number_models=len(models)
Xtrain_new=np.zeros((n_train,number_models))
Xtest_new=np.zeros((n_test,number_models))
for i,classifier in enumerate(models):
    Xtrain_new[:,i],Xtest_new[:,i]=get_oof(classifier,Xtrain_ft,Ytrain_ft,Xtest_ft)

reg=LogisticRegression(penalty="l2",
                       solver="liblinear",
                       C=1,
                       max_iter=5000,
                       random_state=0)   
reg=reg.fit(Xtrain_new,Ytrain_ft)
score=reg.score(Xtest_new,Ytest_ft)
y_pred=reg.predict(Xtest_new)
y_proba=reg.predict_proba(Xtest_new)[:,1]
fpr, tpr, thresholds_ft = roc_curve(Ytest_ft, y_proba)    
cm=confusion_matrix(Ytest_ft, y_pred, labels=[1,0])
auc=roc_auc_score(Ytest_ft, y_proba)

print('Financial+Text')
print(score,cm,auc,sep='\n')
